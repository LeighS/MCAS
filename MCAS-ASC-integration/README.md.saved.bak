## Integrating Microsoft Cloud App Security with Azure Security Center

#### Summary
This article describes how to integrate Microsoft Cloud App Security (MCAS) with Azure Security Center (ASC). We will leverage the MCAS SIEM agent capability to forward CEF over syslog events to an ASC Log Analytics (LA) workspace. From the ASC workspace we can create custom alerts and invoke Logic App playbooks for any custom action, like remediation actions or creating a ticket in a ticketing system.

#### Assumptions
This blogpost is assuming that you have the following in place: <br>
*  A configured MCAS environment, if you don't have a MCAS environment, go <a href="https://docs.microsoft.com/en-us/cloud-app-security/getting-started-with-cloud-app-security" target="_blank">here</a>
* A configured ASC environment, if you don't have an ASC environment, go <a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-get-started" target="_blank">here</a>
 
#### High-level steps
The scenario we want to achieve is at a high-level captured in the following figure: <br>

![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/highlevel_overview.png)
<br>
<br>

To configure the MCAS integration with ASC we are going to perform the following steps.
1.	Create a new VM in Azure, running Ubuntu 18.04 LTS, we will refer to this VM as the MCAS-SIEM-MMA VM
Note: you can also leverage a Windows VM, but this blog leverages Linux as an example
2.	Configure the SIEM agent in MCAS
3.	Download and install Java 8
4.	Install and configure the MCAS SIEM agent
5.	Install and configure the Microsoft Management Agent (MMA)
6.	Configure the MMA to forward MCAS alert and activities to Log Analytics
7.	Create a MCAS alert and verify it appears in the ASC Log Analytics workspace
8.	Create a custom Azure Security Center alert

### Step 1 – Create the SIEM Agent VM in Azure
In this section we are going to create a new Azure Linux VM and configure the prerequisites.
1.	Open the Azure Portal and create a new Ubuntu Server 18.04 LTS VM, using a SSH public key is a security best practice:

![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/create_vm.png)
<br>
<br>

2.	Provide a name and select your hardware configuration
a.	Please note that for a production environment the following is recommended for the MCAS SIEM agent VM:<br>
CPU: 2 <br>
Disk space: 20 GB <br>
RAM: 2 GB <br>
The server must be running Java 8. Earlier versions are not supported. <br>
Set your firewall as described in <a href="https://docs.microsoft.com/en-us/cloud-app-security/network-requirements" target="_blank">network requirements</a>

3.	Configure the remainder of the Azure create VM wizard as you see fit, but make sure to add a public port for SSH (port 22) <br>
![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/ssh_port.png)
<br>
<br>

4. When the VM has been deployed, make sure to make a note of the VM’s public IP address, which can be found under the VM overview settings: <br>
![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/public_ip.png)
<br>
<br>

5.	Since we are going to send CEF over syslog data to this VM, we need to add an NSG rule which allows UDP traffic over port 514. Configure the source and destination for better locked down security.
![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/inbound_rules.png)
<br>
<br>

### Step 2 - Configure the SIEM agent in MCAS
For a full description how to configure the MCAS SIEM agent, please go here 
1.	Open the Cloud App Security portal and click on **Settings** -> **Security extensions**
![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/security_extensions.png)
<br>
<br>

2.	In the SIEM agents tab, click on the **"+"** sign in the upper right corner <br> 
![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/siem_agent.png)
<br>
<br>

3.	Click on **Start Wizard** to start the SIEM agent configuration wizard
4.	Provide an Agent Name, select Generic CEF as the SIEM format and make sure to select **RFC 3164, include PRI, include system name**
a.	These settings ensure the usage of the correct CEF schema, priority and sending hostname (for easier querying) <br>
![alt text](https://raw.githubusercontent.com/tianderturpijn/MCAS/master/MCAS-ASC-integration/screenshots/configure_siem_agent.png)
<br>
Click on **Next**

5.	Fill in the **Remote Syslog host** field by providing the public IP address of the Linux VM you have created in “Create the SIEM Agent VM in Azure”, step 4.
In our example we are using port 514 as the **remote syslog port** and UDP as the **remote syslog protocol**, but this can be any port and either TCP or UDP.



